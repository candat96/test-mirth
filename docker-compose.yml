version: '3.8'

services:
  # Mirth Connect Server
  mirth-connect:
    image: nextgenhealthcare/connect:latest
    container_name: mirth-connect
    environment:
      - DATABASE=postgres
      - DATABASE_URL=jdbc:postgresql://postgres:5432/mirthdb
      - DATABASE_MAX_CONNECTIONS=20
      - VMOPTIONS=-Xmx1024m
    env_file:
      - .env
    secrets:
      - mirth_properties
    volumes:
      - ./data/appdata:/opt/connect/appdata
      - ./data/custom-extensions:/opt/connect/custom-extensions
      - ./data/custom-lib:/opt/connect/custom-lib
    ports:
      # Mirth Admin Dashboard
      - "8443:8443"
      # Mirth Web Server (internal API)
      - "8080:8080"
      # HTTP Listener Channels
      - "8081:8081"
      - "8082:8082"
      - "8083:8083"
      - "8084:8084"
      - "8085:8085"
      # HL7 MLLP Listeners
      - "6661:6661"
      - "6662:6662"
      - "6663:6663"
      - "6664:6664"
      - "6665:6665"
      # DICOM
      - "11112:11112"
      # FHIR
      - "8090:8090"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - mirth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:8443/api/server/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # PostgreSQL Database for Mirth
  postgres:
    image: postgres:15-alpine
    container_name: mirth-postgres
    environment:
      - POSTGRES_DB=mirthdb
      - POSTGRES_USER_FILE=/run/secrets/postgres-user
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres-password
      - PGDATA=/var/lib/postgresql/data/pgdata
    secrets:
      - postgres-user
      - postgres-password
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    expose:
      - 5432
    networks:
      - mirth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mirthuser -d mirthdb"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  mirth-network:
    driver: bridge

secrets:
  mirth_properties:
    file: ./secrets/mirth.properties
  postgres-user:
    file: ./secrets/postgres_user.txt
  postgres-password:
    file: ./secrets/postgres_password.txt
